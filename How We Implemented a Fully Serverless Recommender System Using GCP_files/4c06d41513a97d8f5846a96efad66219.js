document.write('<link rel="stylesheet" href="https://assets-cdn.github.com/assets/gist-embed-2c768148c4d27cab10fe818942078e18.css">')
document.write('<div id=\"gist82572870\" class=\"gist\">\n    <div class=\"gist-file\">\n      <div class=\"gist-data\">\n        <div class=\"js-gist-file-update-container js-task-list-container file-box\">\n  <div id=\"file-example_dataproc_customers_interaction-sql\" class=\"file\">\n    \n\n  <div itemprop=\"text\" class=\"blob-wrapper data type-sql \">\n      <table class=\"highlight tab-size js-file-line-container\" data-tab-size=\"8\">\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L1\" class=\"blob-num js-line-number\" data-line-number=\"1\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC1\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#<\/span>standardSQL<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L2\" class=\"blob-num js-line-number\" data-line-number=\"2\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC2\" class=\"blob-code blob-code-inner js-file-line\">CREATE TEMP FUNCTION process_sku(sku STRING) <span class=\"pl-k\">AS<\/span> (<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L3\" class=\"blob-num js-line-number\" data-line-number=\"3\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC3\" class=\"blob-code blob-code-inner js-file-line\">  CASE WHEN (CHAR_LENGTH(sku) <span class=\"pl-k\">-<\/span> CHAR_LENGTH(REGEXP_REPLACE(sku, r<span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>-<span class=\"pl-pds\">&#39;<\/span><\/span>, <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span><span class=\"pl-pds\">&#39;<\/span><\/span>)) <span class=\"pl-k\">=<\/span> <span class=\"pl-c1\">3<\/span>) <span class=\"pl-k\">OR<\/span> (CHAR_LENGTH(sku) <span class=\"pl-k\">-<\/span> CHAR_LENGTH(REGEXP_REPLACE(sku, r<span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>-<span class=\"pl-pds\">&#39;<\/span><\/span>, <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span><span class=\"pl-pds\">&#39;<\/span><\/span>)) <span class=\"pl-k\">=<\/span> <span class=\"pl-c1\">1<\/span>) THEN REGEXP_EXTRACT(sku, r<span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>(.*)-[0-9A-Z]+<span class=\"pl-pds\">&#39;<\/span><\/span>)<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L4\" class=\"blob-num js-line-number\" data-line-number=\"4\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC4\" class=\"blob-code blob-code-inner js-file-line\">     ELSE sku END<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L5\" class=\"blob-num js-line-number\" data-line-number=\"5\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC5\" class=\"blob-code blob-code-inner js-file-line\">);<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L6\" class=\"blob-num js-line-number\" data-line-number=\"6\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC6\" class=\"blob-code blob-code-inner js-file-line\">\n<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L7\" class=\"blob-num js-line-number\" data-line-number=\"7\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC7\" class=\"blob-code blob-code-inner js-file-line\">\n<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L8\" class=\"blob-num js-line-number\" data-line-number=\"8\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC8\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-k\">SELECT<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L9\" class=\"blob-num js-line-number\" data-line-number=\"9\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC9\" class=\"blob-code blob-code-inner js-file-line\">  user,<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L10\" class=\"blob-num js-line-number\" data-line-number=\"10\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC10\" class=\"blob-code blob-code-inner js-file-line\">  productSku,<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L11\" class=\"blob-num js-line-number\" data-line-number=\"11\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC11\" class=\"blob-code blob-code-inner js-file-line\">  type<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L12\" class=\"blob-num js-line-number\" data-line-number=\"12\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC12\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-k\">FROM<\/span>(<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L13\" class=\"blob-num js-line-number\" data-line-number=\"13\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC13\" class=\"blob-code blob-code-inner js-file-line\">  <span class=\"pl-k\">SELECT<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L14\" class=\"blob-num js-line-number\" data-line-number=\"14\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC14\" class=\"blob-code blob-code-inner js-file-line\">    fullvisitorid user,<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L15\" class=\"blob-num js-line-number\" data-line-number=\"15\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC15\" class=\"blob-code blob-code-inner js-file-line\">    ARRAY(<span class=\"pl-k\">SELECT<\/span> <span class=\"pl-k\">AS<\/span> STRUCT process_sku(productSku) productSku, CASE WHEN <span class=\"pl-c1\">ecommerceAction<\/span>.<span class=\"pl-c1\">action_type<\/span> <span class=\"pl-k\">=<\/span> <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>2<span class=\"pl-pds\">&#39;<\/span><\/span> THEN <span class=\"pl-c1\">1<\/span> WHEN <span class=\"pl-c1\">ecommerceAction<\/span>.<span class=\"pl-c1\">action_type<\/span> <span class=\"pl-k\">=<\/span> <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>3<span class=\"pl-pds\">&#39;<\/span><\/span> THEN <span class=\"pl-c1\">2<\/span> ELSE <span class=\"pl-c1\">3<\/span> END type <span class=\"pl-k\">FROM<\/span> UNNEST(hits), UNNEST(product) <span class=\"pl-k\">WHERE<\/span> <span class=\"pl-c1\">ecommerceAction<\/span>.<span class=\"pl-c1\">action_type<\/span> <span class=\"pl-k\">in<\/span> (<span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>2<span class=\"pl-pds\">&#39;<\/span><\/span>, <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>3<span class=\"pl-pds\">&#39;<\/span><\/span>, <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>6<span class=\"pl-pds\">&#39;<\/span><\/span>)) interactions<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L16\" class=\"blob-num js-line-number\" data-line-number=\"16\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC16\" class=\"blob-code blob-code-inner js-file-line\">  <span class=\"pl-k\">FROM<\/span> <span class=\"pl-s\"><span class=\"pl-pds\">`<\/span>{project_id}.{dataset_id}.{table_id}<span class=\"pl-pds\">`<\/span><\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L17\" class=\"blob-num js-line-number\" data-line-number=\"17\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC17\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-k\">WHERE<\/span> TRUE<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L18\" class=\"blob-num js-line-number\" data-line-number=\"18\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC18\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-k\">AND<\/span> _TABLE_SUFFIX <span class=\"pl-k\">=<\/span> <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>{date}<span class=\"pl-pds\">&#39;<\/span><\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L19\" class=\"blob-num js-line-number\" data-line-number=\"19\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC19\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-k\">AND<\/span> EXISTS(<span class=\"pl-k\">SELECT<\/span> <span class=\"pl-c1\">1<\/span> <span class=\"pl-k\">FROM<\/span> UNNEST(hits) <span class=\"pl-k\">WHERE<\/span> <span class=\"pl-c1\">ecommerceAction<\/span>.<span class=\"pl-c1\">action_type<\/span> <span class=\"pl-k\">IN<\/span> (<span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>2<span class=\"pl-pds\">&#39;<\/span><\/span>, <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>3<span class=\"pl-pds\">&#39;<\/span><\/span>, <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>6<span class=\"pl-pds\">&#39;<\/span><\/span>))<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L20\" class=\"blob-num js-line-number\" data-line-number=\"20\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC20\" class=\"blob-code blob-code-inner js-file-line\">),<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-example_dataproc_customers_interaction-sql-L21\" class=\"blob-num js-line-number\" data-line-number=\"21\"><\/td>\n        <td id=\"file-example_dataproc_customers_interaction-sql-LC21\" class=\"blob-code blob-code-inner js-file-line\">UNNEST(interactions)<\/td>\n      <\/tr>\n<\/table>\n\n\n  <\/div>\n\n  <\/div>\n<\/div>\n\n      <\/div>\n      <div class=\"gist-meta\">\n        <a href=\"https://gist.github.com/WillianFuks/4c06d41513a97d8f5846a96efad66219/raw/f89bd7154ef92a41c697e70f70c32966c75ea799/example_dataproc_customers_interaction.sql\" style=\"float:right\">view raw<\/a>\n        <a href=\"https://gist.github.com/WillianFuks/4c06d41513a97d8f5846a96efad66219#file-example_dataproc_customers_interaction-sql\">example_dataproc_customers_interaction.sql<\/a>\n        hosted with &#10084; by <a href=\"https://github.com\">GitHub<\/a>\n      <\/div>\n    <\/div>\n<\/div>\n')
